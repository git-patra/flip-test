# flip-test

## Overview

This repository is a Go project implementing statement processing logic (usecases, domain entities, and repository implementations).
Core code is organized under `internal/pkg/statements` and tests exercise usecase behavior such as balance and issues retrieval.

## Architecture overview

- (DDD) Layered, hexagonal style with clear separation of concerns:
  - `internal/pkg/statements/domain` - domain entities (e.g. `Transaction`) and domain constants.
  - `internal/pkg/statements/usecase` - business logic / application usecases (e.g. `GetBalanceUsecase`, `GetIssuesUsecase`).
  - `internal/pkg/statements/infrastructure` - repository implementations (in-memory repo used in tests; replaceable with a DB-backed repo).
  - `internal/pkg/statements/delivery` - HTTP handlers exposing usecases as REST endpoints.
  - Tests live alongside the implementation in the same package, e.g. `internal/pkg/statements/usecase/\`get_balance_usecase_impl_test.go\`` and similar.

- Design choices:
  - Usecases depend on repository abstractions (interfaces) allowing easy test doubles and in-memory repos for fast unit tests.
  - Small, focused entities and usecase functions for testability.

## Trade-offs

| Desain / Komponen | Keputusan yang Diambil |
|-------------------|------------------------|
| **In-Memory Repository** | Semua transaksi disimpan di memori (tanpa database) |
| **Streaming CSV Parsing** | File CSV dibaca baris demi baris, bukan dimuat penuh ke RAM |
| **In-Memory Event Bus (Channel-based)** | Menggunakan `chan` & custom exchange sebagai pengganti RabbitMQ |
| **Worker Pool** | Event `FAILED` dan `PENDING` diproses asinkron oleh worker pool |
| **Single Process Architecture** | Semua komponen (HTTP, bus, worker) berjalan di satu service |
| **At-Most-Once Event Delivery** | Event drop jika queue penuh untuk menjaga non-blocking publish |
| **Stateless Worker Logic** | Worker tidak menyimpan status proses di luar memori |

## How to run

Prerequisites:
- Install Go (recommended Go 1.20 or newer).
- Clone the repository:
  - `git clone git@github.com:git-patra/flip-test.git`
  - `cd flip-test`

Run tests:
- Run all tests:
  - `go test ./...`
- Run only statements usecase tests:
  - `go test ./internal/pkg/statements/...`
- Run integration test only:
    - `go test -v ./internal/pkg/statements/interfaces/http -run Integration -count=1`
- Run with race detector (Makefile target):
    - `make race`

Run the application:
  - `go mod tidy` (to ensure dependencies are up to date)
  - `make run`

## Notes

- Module path and exact commands depend on the declared `module` in `go.mod`.
- Replace the in-memory repository in `internal/pkg/statements/infrastructure/repo` with a production store when persisting data is required.

## Documentation and Test

- csv file example: docs/flip-test.csv (in this repo)
- Postman collection: docs/Flip-Test.postman_collection.json (in this repo)

- Statement CURL Example:
```bash
curl --location 'http://localhost:8016/api/v1/statements' \
--form 'file=@"/Users/patra/Documents/flip-test.csv"'
```

- Get Balance CURL Example:
```bash
curl --location 'http://localhost:8016/api/v1/balance?upload_id=674d7ce0-8f21-4d20-ab50-7f1b769350c5'
```

- Get Issues CURL Example:
```bash
curl --location 'http://localhost:8016/api/v1/transactions/issues?upload_id=674d7ce0-8f21-4d20-ab50-7f1b769350c5'
```